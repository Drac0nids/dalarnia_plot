from web3 import Web3
import  plotStorage
import myPlotRent

bsc_mainnet_url = "https://bsc-dataseed.binance.org/"
bsc_mainnet_url2 = "https://nd-925-819-351.p2pify.com/5b2788aca1e7e4db27ff83f28fe2809d"
web3 = Web3(Web3.HTTPProvider(bsc_mainnet_url2))

plotHandler_contract_address = "0x7DA8Fd65e48BBB8c22D9B1E8bC11D601897e8dE9"

plotHandler_contract_abi = """[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"renter","type":"address"},{"indexed":false,"internalType":"address","name":"plotOwner","type":"address"},{"indexed":false,"internalType":"uint256","name":"plotId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"digsClosed","type":"uint256"}],"name":"CloseRentAndMint","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8","name":"version","type":"uint8"}],"name":"Initialized","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"renter","type":"address"},{"indexed":false,"internalType":"uint256","name":"plotId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"nrOfDigs","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"digsLeft","type":"uint256"}],"name":"Rent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PAUSER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"breakRent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"resourceIds","type":"uint256[]"},{"internalType":"uint256[]","name":"resourceAmounts","type":"uint256[]"},{"internalType":"uint256","name":"digsToClose","type":"uint256"},{"internalType":"uint256","name":"plotId","type":"uint256"},{"internalType":"bytes","name":"prefix","type":"bytes"},{"internalType":"uint8","name":"v","type":"uint8"},{"internalType":"bytes32","name":"r","type":"bytes32"},{"internalType":"bytes32","name":"s","type":"bytes32"}],"name":"closeRentAndMint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"fallbackRent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"fixedRent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_planetPlots","type":"address"},{"internalType":"address","name":"_plotState","type":"address"},{"internalType":"address","name":"_planetPassHandler","type":"address"},{"internalType":"address","name":"_tokenFacade","type":"address"},{"internalType":"address","name":"_resources","type":"address"},{"internalType":"address","name":"_taxAccount","type":"address"},{"internalType":"address","name":"_signerAccount","type":"address"},{"internalType":"address","name":"_defaultAdmin","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"internalNonce","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxOpenDigs","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"miningSafetyCap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"plotId","type":"uint256"},{"internalType":"uint8","name":"digsToOpen","type":"uint8"},{"internalType":"uint256","name":"currentRent","type":"uint256"},{"internalType":"uint8","name":"v","type":"uint8"},{"internalType":"bytes32","name":"r","type":"bytes32"},{"internalType":"bytes32","name":"s","type":"bytes32"}],"name":"openRentPlot","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"planetPassHandler","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"planetPlots","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"plotState","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"resources","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_planetPassHandler","type":"address"}],"name":"setPlanetPassHandler","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_signerAccount","type":"address"}],"name":"setSigner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"signerAccount","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"staticTax","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taxAccount","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taxRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tokenFacade","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_maxOpenDigs","type":"uint8"}],"name":"updateDigLimit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"value","type":"uint256"}],"name":"updateFallbackRent","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_miningSafetyCap","type":"uint256"}],"name":"updateMiningSafetyCap","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_taxRate","type":"uint256"}],"name":"updateTax","outputs":[],"stateMutability":"nonpayable","type":"function"}]"""

plotHandler_contract = web3.eth.contract(address=plotHandler_contract_address, abi=plotHandler_contract_abi)

rent_event_filter = plotHandler_contract.events.Rent.create_filter(from_block = "latest")

def rentEvent():
    while True:
        newEvent = rent_event_filter.get_new_entries()
        if len(newEvent):
            # 提取监听到的事件，并进行解析
            for event in newEvent:
                plotId = event['args']['plotId']
                nrOfDigs = event['args']['nrOfDigs']
                digsLeft = event['args']['digsLeft'] - nrOfDigs
                print(plotId, nrOfDigs, digsLeft)
                if plotStorage.isPlotExist(plotId) == None:
                    planet, x, y = plotStorage.parsePlotId(plotId)
                    plotStorage.insert_plot(plotId, planet, x, y)
                    plotStorage.update_digleft(plotId, digsLeft)
                else:
                    plotStorage.update_digleft(plotId, digsLeft)
                if str(plotId) in ('103006020018', '103002015001', '103007030019', '102007029020', '101016039034', '103001005001', '103006014011', '103003021001', '101002017003', '102007030015', '102014015037', '102001006005', '103013010031', '103009005030', '103014020035', '101006019015', '101006012018', '103003025008', '102014012032', '101006015015', '102016040038', '102005006020', '101006020017', '103001006009', '103010014030', '101005004020', '101008031020', '101003029001', '102013005031', '102010013025', '102012033025', '102009005030', '102005009017', '102008033019', '103013009034', '102013004039', '101005008020', '102014016036', '101014012040', '103011030026', '103004033004', '101008037012', '102015026037', '103011022030', '101007021020', '103011029028', '101012031027', '102013001040', '101004034010', '102016040040', '103005010015', '102003030006', '101013005034', '102009002024', '103012033028', '101008035011'):
                    print(plotId,nrOfDigs,digsLeft)
                    myPlotRent.insert_plot_log(plotId,nrOfDigs,digsLeft)

if __name__ == '__main__':
    rentEvent()





