from web3 import Web3
import time
import plotStorage
bsc_mainnet_url = "https://bsc-dataseed.binance.org/"
bsc_mainnet_url2 = "https://nd-925-819-351.p2pify.com/5b2788aca1e7e4db27ff83f28fe2809d"
web3 = Web3(Web3.HTTPProvider(bsc_mainnet_url2))
replenish_contract_address = "0xd02842b4B8482b06187B6C18ED47A348dAA6c85b"

replenish_contract_abi = """[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8","name":"version","type":"uint8"}],"name":"Initialized","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"tier","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"updatedRent","type":"uint256"}],"name":"MinimumTierRentSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"plotId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"tier","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"updatedRent","type":"uint256"}],"name":"PlotRentSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"plotId","type":"uint256"},{"indexed":false,"internalType":"uint256[]","name":"upgradedTiers","type":"uint256[]"},{"indexed":false,"internalType":"uint256","name":"darAmountToRevenue","type":"uint256"}],"name":"PlotTierUpgraded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"cooldownInSecFrom","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"cooldownInSecTo","type":"uint256"}],"name":"ReplenishCooldownSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"plotId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"recipeId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"nextDifferntTierReplenishTimestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"nextSameTierReplenishTimestamp","type":"uint256"}],"name":"ReplenishPlot","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"tier","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"cooldownInSecFrom","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"cooldownInSecTo","type":"uint256"}],"name":"ReplenishTierCooldownSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"recipeId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"tier","type":"uint256"},{"indexed":false,"internalType":"uint256[]","name":"resourceIds","type":"uint256[]"},{"indexed":false,"internalType":"uint256[]","name":"resourceAmounts","type":"uint256[]"}],"name":"TerraformingRecipeSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"recipeId","type":"uint256"},{"indexed":false,"internalType":"uint256[]","name":"tiers","type":"uint256[]"},{"indexed":false,"internalType":"uint256","name":"darAmount","type":"uint256"}],"name":"TierUpgradeRecipeSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"GAME_CONTROL","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PAUSER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"recipeId","type":"uint256"}],"name":"getTerraformingRecipe","outputs":[{"components":[{"internalType":"uint256","name":"tier","type":"uint256"},{"internalType":"uint256[]","name":"resourceIds","type":"uint256[]"},{"internalType":"uint256[]","name":"resourceAmounts","type":"uint256[]"}],"internalType":"struct IPlanetPlotReplenish.TerraformingRecipe","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"recipeId","type":"uint256"}],"name":"getTierUpgradeRecipe","outputs":[{"components":[{"internalType":"uint256[]","name":"tiers","type":"uint256[]"},{"internalType":"uint256","name":"darAmount","type":"uint256"}],"internalType":"struct IPlanetPlotReplenish.TierUpgradeRecipe","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_planetPlots","type":"address"},{"internalType":"address","name":"_plotState","type":"address"},{"internalType":"address","name":"_tokenFacade","type":"address"},{"internalType":"address","name":"_resources","type":"address"},{"internalType":"address","name":"_taxAccount","type":"address"},{"internalType":"address","name":"defaultAdmin","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"minimumRentFallback","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"minimumTierRentMap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"nextPlotReplenishTimestamp","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"nextTierReplenishTimestamp","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"planetPlots","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"plotMaxReplenishValue","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"plotReplenishCooldownDuration","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"plotState","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"plotTierUpgradeMap","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"plotId","type":"uint256"},{"internalType":"uint256","name":"recipeId","type":"uint256"},{"internalType":"uint256","name":"rent","type":"uint256"}],"name":"replenishPlot","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"plotIds","type":"uint256[]"},{"internalType":"uint256[]","name":"recipeIds","type":"uint256[]"},{"internalType":"uint256[]","name":"rents","type":"uint256[]"}],"name":"replenishPlotBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"replenishedPlotTierMap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"resources","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_plotReplenishCooldownDuration","type":"uint256"},{"internalType":"uint256","name":"_tierReplenishCooldownDuration","type":"uint256"}],"name":"setCooldownDuration","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"value","type":"uint256"}],"name":"setMinimumFallbackRent","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"tiers","type":"uint256[]"},{"internalType":"uint256[]","name":"rents","type":"uint256[]"}],"name":"setMinimumTierRentBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"value","type":"uint256"}],"name":"setPlotMaxReplenishValue","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"plotId","type":"uint256"},{"internalType":"uint256","name":"rent","type":"uint256"}],"name":"setPlotRent","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"plotIds","type":"uint256[]"},{"internalType":"uint256[]","name":"rentValues","type":"uint256[]"}],"name":"setPlotRentBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"components":[{"internalType":"uint256","name":"tier","type":"uint256"},{"internalType":"uint256[]","name":"resourceIds","type":"uint256[]"},{"internalType":"uint256[]","name":"resourceAmounts","type":"uint256[]"}],"internalType":"struct IPlanetPlotReplenish.TerraformingRecipe[]","name":"recipes","type":"tuple[]"}],"name":"setTerraformingRecipeBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"tiers","type":"uint256[]"},{"internalType":"uint256[]","name":"cooldowns","type":"uint256[]"}],"name":"setTierCooldownDurationByTier","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"recipeId","type":"uint256"},{"components":[{"internalType":"uint256[]","name":"tiers","type":"uint256[]"},{"internalType":"uint256","name":"darAmount","type":"uint256"}],"internalType":"struct IPlanetPlotReplenish.TierUpgradeRecipe","name":"recipe","type":"tuple"}],"name":"setTierUpgradeRecipe","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"tiers","type":"uint256[]"}],"name":"setTierUpgradeRequired","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taxAccount","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"terraformingRecipeMap","outputs":[{"internalType":"uint256","name":"tier","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tierReplenishCooldownDuration","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"tierReplenishCooldownDurationMap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"tierUpgradeRecipeMap","outputs":[{"internalType":"uint256","name":"darAmount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"tierUpgradeRequiredMap","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"tokenFacade","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"plotId","type":"uint256"},{"internalType":"uint256","name":"recipeId","type":"uint256"}],"name":"upgradePlot","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"plotIds","type":"uint256[]"},{"internalType":"uint256[]","name":"recipeIds","type":"uint256[]"}],"name":"upgradePlotBatch","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"plotId","type":"uint256"},{"internalType":"uint256[]","name":"tiers","type":"uint256[]"}],"name":"upgradePlotFor","outputs":[],"stateMutability":"nonpayable","type":"function"}]"""

replenish_contract = web3.eth.contract(address=replenish_contract_address, abi=replenish_contract_abi)

rentset_envnt_filter = replenish_contract.events.PlotRentSet.create_filter(from_block = "latest")

def rentsetEvent():
    while True:
        newEvent = rentset_envnt_filter.get_new_entries()
        if len(newEvent):
            for event in newEvent:
                plotId = event['args']['plotId']
                updatedRent = event['args']['updatedRent']
                print(plotId,updatedRent)
                if plotStorage.isPlotExist(plotId) == None:
                    planet, x, y = plotStorage.parsePlotId(plotId)
                    plotStorage.insert_plot(plotId, planet, x, y)
                    rent = updatedRent/1000000
                    plotStorage.update_rent(plotId,rent)
                else:
                    rent = updatedRent / 1000000
                    plotStorage.update_rent(plotId,rent)
                #time.sleep(1)

if __name__ == '__main__':
    rentsetEvent()